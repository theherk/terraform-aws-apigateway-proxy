# terraform aws apigateway proxy

Terraform module to create an api gateway that proxies requests. It also can create a domain name and supports an authorizer that can be provided by giving a lambda.

This module supports a very powerful route declaration. You can declare a full set of paths, each with different method configuration.

In addition, it has two more clever tricks up its sleeves. It will by default, for any routes given with path ending in `{proxy+}` and method config uri ending in `{proxy}`, generate another route for proxying the base route. For example, if a route given is:

```hcl
{
  path    = "/v1/{proxy+}"
  methods = ["ANY"]
  config  = { uri = "example.com/v1/{proxy}" }
}
```

and no other routes are given with path "/v1" and url "example.com", then a default base proxy path should be created, such as:

```hcl
{
  path    = "/v1"
  methods = ["ANY"]
  config  = { uri = "example.com/v1" }
}
```

If the preceding statement is not true, then this assumes your explicit configuration is correct. You can override this behavior by passing `generate_base_proxies = false`.

Additionally, it will automatically include any nested resources that aren't explicitly declared, but are nevertheless required for a given method's depth.

## Usage

This module is intended to be used in conjunction with [terraform-aws-apigateway-route-builder](https://github.com/theherk/terraform-aws-apigateway-route-builder/), but it is not a dependency. You can construct the `methods` and `resources` objects explicitly, but these are meant to be somewhat opinionated abstractions.

```hcl
module "api" {
  source = "theherk/apigateway-proxy/aws"

  name        = "h4s-simple"
  stage_name  = "dev"
  vpc_link_id = "ab3ced"

  resources = module.builder.resources
  methods   = module.builder.methods
}
```

### Examples

- [Simple](examples/simple)
- [Complete](examples/complete)

### CORS

Starting at version 2.0.0, responses can be specified. This allows using `MOCK` type integrations to return a 200 preflight with necessary headers. See the [Complete Example](examples/complete) to see how to create an OPTIONS response.

### Private

Private rest api's can be created too, by passing `PRIVATE` as the `endpoint_type`. In this case the whitelist is used in conduction with given `source_vpc_endpoints` to build the resource policy.

## Contributing

To work on this repository, you need to install the [pre-commit](https://github.com/pre-commit/pre-commit) hooks, and dependencies from [pre-commit-terraform](https://github.com/antonbabenko/pre-commit-terraform).

    make pre-commit

That should be the easy way, but if you use another package manager than `apt`, `brew`, or `yum` or want to configure these differently on your system, you can do so by following the guidance [here](https://github.com/antonbabenko/pre-commit-terraform#1-install-dependencies). For instance, you can set this up to use docker for running checks rather than installing directly to your filesystem.

After doing this, several checks will be run when attempting commits.

---

_note_: The following is generated by `terraform docs`.

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Requirements

| Name                                                                     | Version  |
| ------------------------------------------------------------------------ | -------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 1.3.0 |
| <a name="requirement_aws"></a> [aws](#requirement_aws)                   | >= 3.64  |

## Providers

| Name                                             | Version |
| ------------------------------------------------ | ------- |
| <a name="provider_aws"></a> [aws](#provider_aws) | 5.4.0   |

## Modules

No modules.

## Resources

| Name                                                                                                                                                      | Type        |
| --------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [aws_api_gateway_authorizer.authorizer](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_authorizer)               | resource    |
| [aws_api_gateway_base_path_mapping.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_base_path_mapping)       | resource    |
| [aws_api_gateway_deployment.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_deployment)                     | resource    |
| [aws_api_gateway_domain_name.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_domain_name)                   | resource    |
| [aws_api_gateway_integration.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_integration)                   | resource    |
| [aws_api_gateway_integration_response.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_integration_response) | resource    |
| [aws_api_gateway_method.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_method)                             | resource    |
| [aws_api_gateway_method_response.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_method_response)           | resource    |
| [aws_api_gateway_method_settings.s_all](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_method_settings)          | resource    |
| [aws_api_gateway_resource.depth_0](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_resource)                      | resource    |
| [aws_api_gateway_resource.depth_1](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_resource)                      | resource    |
| [aws_api_gateway_resource.depth_2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_resource)                      | resource    |
| [aws_api_gateway_resource.depth_3](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_resource)                      | resource    |
| [aws_api_gateway_resource.depth_4](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_resource)                      | resource    |
| [aws_api_gateway_rest_api.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_rest_api)                         | resource    |
| [aws_api_gateway_rest_api_policy.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_rest_api_policy)           | resource    |
| [aws_api_gateway_stage.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/api_gateway_stage)                               | resource    |
| [aws_cloudwatch_log_group.access](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group)                       | resource    |
| [aws_cloudwatch_log_group.exec](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group)                         | resource    |
| [aws_iam_policy.authorizer](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy)                                       | resource    |
| [aws_iam_role.authorizer](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role)                                           | resource    |
| [aws_iam_role_policy_attachment.authorizer](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment)       | resource    |
| [aws_route53_record.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record)                                     | resource    |
| [aws_iam_policy_document.authorizer](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)                  | data source |
| [aws_iam_policy_document.authorizer_assume_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)      | data source |
| [aws_iam_policy_document.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)                        | data source |

## Inputs

| Name                                                                                 | Description                    | Type       | Default                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Required |
| ------------------------------------------------------------------------------------ | ------------------------------ | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: |
| <a name="input_access_log_format"></a> [access_log_format](#input_access_log_format) | Format for access log entries. | `map(any)` | <pre>{<br> "contextPath": "$context.path",<br>  "domainName": "$context.domainName",<br> "error.message": "$context.error.message",<br>  "httpMethod": "$context.httpMethod",<br> "ip": "$context.identity.sourceIp",<br>  "protocol": "$context.protocol",<br> "requestId": "$context.requestId",<br>  "requestTime": "$context.requestTime",<br> "responseLength": "$context.responseLength",<br>  "routeKey": "$context.routeKey",<br> "status": "$context |
